<h1>Advanced servo control interface below</h1>

<br>
<h3>Keybinds:</h3>
<p>
Left side: Q forward, A backward
Right side: W forward, S backward

Front pivot: Up-Arrow pivot down, Down-Arrow pivot up
Back pivot: Left-Arrow pivot up, Right-Arrow pivot down
</p>


<input type="range" id="powerSlider" min="0", max="4000", value="0">
<input type="number" id="powerField" value="0">

<h3>Status:</h3>

<img style="width: 100%;">

<script>

/*navigator.getUserMedia(
 { video: true, audio: true },
 stream => {
   const localVideo = document.getElementById("local-video");
   if (localVideo) {
     localVideo.srcObject = stream;
   }
 },
 error => {
   console.warn(error.message);
 }
);*/	
	const socket = new WebSocket('ws://192.168.0.176:8081/')
	socket.onopen = (event) => {
		socket.send("Socket opened")
		console.log("Socket opened");
	};
	var isLoadingImage = false
	socket.onmessage = (event) => {
		console.log("Server says " + event.data)
		if (event.data != "Wassap it the server" && !isLoadingImage) {
			isLoadingImage = true
			const imageElem = document.getElementsByTagName("img")[0];
			imageElem.src = 'data:image/png;base64,' + event.data.toString('base64');
			isLoadingImage = false
		}
	};


	/*(async function() {
    		const ws = await connectToServer();

		const messageBody = { "keyCode" : "KeyZ" };
        	ws.send(JSON.stringify(messageBody));

		ws.onmessage = (webSocketMessage) => {
        		const messageBody = JSON.parse(webSocketMessage.data);
    		};

		async function connectToServer() {
        		const ws = new WebSocket('ws://192.168.0.176:8000/ws');
        		return new Promise((resolve, reject) => {
            			const timer = setInterval(() => {
                			if(ws.readyState === 1) {
                    				clearInterval(timer)
                    				resolve(ws);
                			}
            			}, 10);
        		});
    		}
	})();*/


	window.addEventListener("gamepadconnected", (e) => {
  		console.log(
    			"Gamepad connected at index %d: %s. %d buttons, %d axes.",
    			e.gamepad.index,
    			e.gamepad.id,
    			e.gamepad.buttons.length,
    			e.gamepad.axes.length,
  		);
		//gamepad = navigator.getGamepads().find(gamepad => {gamepad !== null});
			

	});

	function asyncCall() {

		var gamepad = navigator.getGamepads().find(gamepad => {gamepad !== null});
		if (typeof gamepad !== 'undefined') {
			const position = gamepad.axes[0];
			console.log( "pos " + position);
		}
		console.log("still moving");
		//window.requestAnimationFrame(asyncCall);
	}
	//window.requestAnimationFrame(asyncCall);


	const slider = document.getElementById("powerSlider");
	const field = document.getElementById("powerField");
	slider.oninput = function() {		
			postJson({"keyCode" : this.value});
			console.log("just sent " + this.value + " to the server");
  	};
	field.addEventListener("keypress", function(event) {
  		if (event.key === "Enter") {
    			event.preventDefault();
			postJson({"keyCode" : this.value});
			console.log("just sent " + this.value + " to the server");
  		}
		
	});
	document.addEventListener('keydown', (event) => {
 		var name = event.key;
 		var code = event.code;
		console.log("keyCode " + event.code);	
		postJson({"keyCode":event.code});
	}, false);


	var sending;
	var latest;
 
	const http = new XMLHttpRequest();

	function postJson(jsonObject) {
		if(sending){
			console.log("Hey, looks like something is in-progress.  Just gonna ignore this", jsonObject)
			latest = jsonObject
		}else{
			sending = jsonObject
		
			http.open("POST", "", true);
	
			http.setRequestHeader("Content-type", "application/json");
	
			http.onload = () => {
				sending = undefined;
				const next = latest
				latest = undefined
				if(next){
					postJson(next)
				}
				console.log("done sending")
			};
	
			const stringified = JSON.stringify(jsonObject)
                	console.log("Posting json: " + stringified);
			http.send(stringified);
		}
	}
</script>
